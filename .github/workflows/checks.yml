name: checks

on:
  workflow_call:

env:
  ZIG_VERSION: "0.15.2"

jobs:
  analyze:
    name: analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-
      - name: check ghostty commit exists
        run: |
          COMMIT=$(cat packages/libghostty/ghostty.version)
          curl -fsSL -o /dev/null "https://github.com/ghostty-org/ghostty/archive/$COMMIT.tar.gz"
      - run: flutter pub get
      - run: dart format --set-exit-if-changed .
      - run: dart analyze .
      - name: publish dry run
        working-directory: packages/libghostty
        run: dart pub publish --dry-run

  test-native:
    name: test-${{ matrix.os }}
    needs: [analyze]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-arm64
            runner: macos-latest
          - os: linux-x64
            runner: ubuntu-latest
          - os: windows-x64
            runner: windows-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-tags: false
      - uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
      - uses: mlugg/setup-zig@d1434d08867e3ee9daa34448df10607b98908d29 # v2.2.1
        with:
          version: ${{ env.ZIG_VERSION }}
      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-
      - name: resolve ghostty source
        id: ghostty
        shell: bash
        run: |
          COMMIT=$(cat packages/libghostty/ghostty.version)
          echo "commit=$COMMIT" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: ghostty-cache
        with:
          path: ghostty
          key: ghostty-src-${{ steps.ghostty.outputs.commit }}-${{ hashFiles('packages/libghostty/patches/*.patch') }}
      - name: download ghostty source
        if: steps.ghostty-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          curl -fsSL "https://github.com/ghostty-org/ghostty/archive/${{ steps.ghostty.outputs.commit }}.tar.gz" -o ghostty.tar.gz
          mkdir -p ghostty
          tar xzf ghostty.tar.gz -C ghostty --strip-components=1
          rm ghostty.tar.gz
      - name: apply patches
        if: steps.ghostty-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          for p in packages/libghostty/patches/*.patch; do
            [ -f "$p" ] || continue
            git apply --ignore-whitespace --whitespace=nowarn --directory=ghostty "$p"
          done
      - run: flutter pub get
      - run: dart pub global activate very_good_cli
      - name: run tests
        working-directory: packages/libghostty
        run: very_good test --no-optimization

  test-wasm:
    name: test-wasm
    needs: [analyze]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-tags: false
      - uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          channel: stable
      - uses: mlugg/setup-zig@d1434d08867e3ee9daa34448df10607b98908d29 # v2.2.1
        with:
          version: ${{ env.ZIG_VERSION }}
      - uses: browser-actions/setup-chrome@c785b87e244131f27c9f19c1a33e2ead956ab7ce # v1.7.3
      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-
      - name: resolve ghostty source
        id: ghostty
        run: |
          COMMIT=$(cat packages/libghostty/ghostty.version)
          echo "commit=$COMMIT" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: ghostty-cache
        with:
          path: ghostty
          key: ghostty-src-${{ steps.ghostty.outputs.commit }}-${{ hashFiles('packages/libghostty/patches/*.patch') }}
      - name: download ghostty source
        if: steps.ghostty-cache.outputs.cache-hit != 'true'
        run: |
          curl -fsSL "https://github.com/ghostty-org/ghostty/archive/${{ steps.ghostty.outputs.commit }}.tar.gz" -o ghostty.tar.gz
          mkdir -p ghostty
          tar xzf ghostty.tar.gz -C ghostty --strip-components=1
          rm ghostty.tar.gz
      - name: apply patches
        if: steps.ghostty-cache.outputs.cache-hit != 'true'
        run: |
          for p in packages/libghostty/patches/*.patch; do
            [ -f "$p" ] || continue
            git apply --ignore-whitespace --whitespace=nowarn --directory=ghostty "$p"
          done
      - name: isolate from repo git
        run: touch ghostty/.git
      - run: flutter pub get
      - run: dart pub global activate very_good_cli
      - name: build wasm
        working-directory: packages/libghostty
        run: dart run tool/build_wasm.dart
      - name: run wasm tests
        working-directory: packages/libghostty
        run: very_good test --platform=chrome test/wasm
