name: release
run-name: release ${{ github.ref_name }}

on:
  push:
    tags: [ "libghostty-v[0-9]*.[0-9]*.[0-9]*" ]

concurrency:
  group: release-libghostty
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  validate:
    name: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: check tag matches versions
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#libghostty-v}"
          PUBSPEC_VERSION=$(grep '^version:' packages/libghostty/pubspec.yaml | awk '{print $2}')
          ASSET_HASH_VERSION=$(grep 'const releaseTag = ' packages/libghostty/lib/src/hook/asset_hashes.dart | sed "s/.*'\(.*\)'.*/\1/" | sed 's/^libghostty-v//; s/^v//')

          if [ "$TAG_VERSION" != "$PUBSPEC_VERSION" ]; then
            echo "::error::pubspec version ($PUBSPEC_VERSION) != tag ($TAG_VERSION). Update pubspec.yaml to match tag."
            exit 1
          fi

          if [ "$TAG_VERSION" != "$ASSET_HASH_VERSION" ]; then
            echo "::error::asset_hashes releaseTag ($ASSET_HASH_VERSION) != tag ($TAG_VERSION). Update asset_hashes.dart to match tag."
            exit 1
          fi
      - name: check ghostty commit exists
        run: |
          COMMIT=$(cat packages/libghostty/ghostty.version)
          curl -fsSL -o /dev/null "https://github.com/ghostty-org/ghostty/archive/$COMMIT.tar.gz"

  github-release:
    name: github-release
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: download artifacts from main
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build.yml
          branch: main
          path: artifacts
          skip_unpack: true
      - name: extract artifacts
        run: |
          for f in artifacts/*.zip; do
            unzip -o "$f" -d artifacts/
            rm "$f"
          done
      - name: validate asset hashes
        run: |
          for f in artifacts/libghostty-*; do
            ext="${f##*.}"
            case "$ext" in
              dylib|so|dll|wasm) ;;
              *) continue ;;
            esac
            filename=$(basename "$f")
            hash=$(sha256sum "$f" | cut -d' ' -f1)
            expected=$(grep "'$filename':" packages/libghostty/lib/src/hook/asset_hashes.dart | sed "s/.*': '\([^']*\)'.*/\1/")
            if [ "$hash" != "$expected" ]; then
              echo "::error::Hash mismatch for $filename"
              echo "Expected: $expected"
              echo "Actual:   $hash"
              exit 1
            fi
            echo "Validated $filename"
          done
      - name: prepare artifacts
        run: |
          # Remove asset-hashes directory (not needed for release)
          rm -rf artifacts/asset-hashes
      - name: extract release notes from CHANGELOG
        run: |
          VERSION="${GITHUB_REF_NAME#libghostty-v}"
          CHANGELOG="packages/libghostty/CHANGELOG.md"
          ./.github/scripts/extract-changelog.sh --skip-header $CHANGELOG "$VERSION" > release-notes.md
          cat release-notes.md
      - name: create github release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${GITHUB_REF_NAME#libghostty-v}"
          PRERELEASE=""
          if echo "$VERSION" | grep -q '-'; then
            PRERELEASE="--prerelease"
          fi
          gh release create "${{ github.ref_name }}" \
            --title "libghostty v${VERSION}" \
            --notes-file release-notes.md \
            $PRERELEASE \
            artifacts/*

  publish:
    needs: [github-release]
    if: startsWith(github.ref_name, 'libghostty-v')
    permissions:
      id-token: write
    uses: dart-lang/setup-dart/.github/workflows/publish.yml@v1
    with:
      environment: pub.dev
      working-directory: packages/libghostty
